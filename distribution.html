<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Time Distribution (by Category)</title>
<style>
body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  line-height: 1.6;
  max-width: 100ch;
	padding: 2rem;
  margin-left: auto;
  margin-right: auto;
}
  header { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:20px; }
  h1 { margin:0; font-size:20px; }
  input[type="file"], input[type="date"] { font-size:14px; padding:4px 6px; border:1px solid #ccc; border-radius:6px; }
  button, select { padding:8px 10px; border-radius:8px; border:1px solid #ccc; background:#f7f7f8; cursor:pointer; }
  button:active{ transform:translateY(1px); }
  .chart-wrap { width:100%; max-width:900px; margin-top:24px; }
  .tooltip { position:absolute; pointer-events:none; background:#222; color:#fff; padding:6px 8px; border-radius:6px; font-size:13px; opacity:0; transition:opacity .12s; transform:translate(-50%,-110%);}
  .category-title { font-size:18px; font-weight:600; margin-top:30px; margin-bottom:8px; display:flex; align-items:center; gap:8px;}
  .color-box { width:14px; height:14px; border-radius:3px; }
  footer { margin-top:18px; color:#666; font-size:13px; max-width:900px; }
  pre { background:#0b1220; color:#cfe8ff; padding:12px; border-radius:8px; overflow:auto; max-width:900px;}
</style>
</head>
<body>

<header>
  <div>
    <h1>Distribution across 24 hours (by Category)</h1>
    <div style="font-size:13px;color:#444;">Aggregates minutes per hour; one chart per category.</div>
  </div>
  <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
		<input id="file" type="file" accept=".csv,text/csv" />
		<button id="reloadCSV">Reload CSV</button>
		<!--- 		
			<button id="loadExample">Load example CSV</button> 
			--->

    <label style="font-size:13px;">Mode:
      <select id="mode">
        <option value="minutes">Absolute minutes</option>
        <option value="percent">Percent of total</option>
      </select>
    </label>
    <label style="font-size:13px;">From: <input type="date" id="startDate"></label>
    <label style="font-size:13px;">To: <input type="date" id="endDate"></label>
    <button id="applyRange">Apply</button>
   </div>
</header>

<div id="charts"></div>

<section style="margin-top:18px; max-width:900px">
  <details>
    <summary><strong>Example CSV format</strong></summary>
    <pre>
Date,Start,End,Category
2025-09-28,23:45,07:15,Sleep
2025-09-29,14:00,16:30,Studying
2025-09-29,17:00,18:15,Procrastination
2025-09-30,23:30,07:00,Sleep
2025-10-01,20:00,22:00,Studying
2025-10-02,22:50,06:20,Sleep
    </pre>
  </details>
</section>

<footer>
  Notes: Each Category gets its own color and chart. Date range filters by <code>Date</code>.  
  If End ≤ Start, the code assumes the activity passes midnight.
</footer>

<script>
const palette = ['#2563eb','#f97316','#16a34a','#9333ea','#dc2626','#0d9488','#78350f','#db2777'];
const exampleCSV = `Date,Start,End,Category
2025-09-28,23:45,07:15,Sleep
2025-09-29,14:00,16:30,Studying
2025-09-29,17:00,18:15,Procrastination
2025-09-30,23:30,07:00,Sleep
2025-10-01,20:00,22:00,Studying
2025-10-02,22:50,06:20,Sleep
`;

const fileInput = document.getElementById('file');
const loadExampleButton = document.getElementById('loadExample');
const modeSelect = document.getElementById('mode');
const chartsContainer = document.getElementById('charts');
const startInput = document.getElementById('startDate');
const endInput = document.getElementById('endDate');
const applyRangeButton = document.getElementById('applyRange');

const reloadButton = document.getElementById('reloadCSV');
let lastCSVText = '';

let allRows = [];
let lastGrouped = {};

fileInput.addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    lastCSVText = reader.result;
    runCSV(lastCSVText);
  };
  reader.readAsText(f);
});

loadExampleButton.addEventListener('click', () => {
  lastCSVText = exampleCSV;
  runCSV(exampleCSV);
});

reloadButton.addEventListener('click', () => {
  if (lastCSVText) {
    runCSV(lastCSVText);
  } else {
    alert('No CSV loaded yet.');
  }
});

modeSelect.addEventListener('change', () => drawAll(lastGrouped));
applyRangeButton.addEventListener('click', () => applyDateFilter());

function parseCSV(text) {
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
  if (lines.length <= 1) return [];
  const header = lines[0].split(',').map(h => h.trim().toLowerCase());
  const idxDate = header.indexOf('date');
  const idxStart = header.findIndex(h => h.includes('start'));
  const idxEnd = header.findIndex(h => h.includes('end'));
  const idxCat = header.findIndex(h => h.includes('cat'));
  const rows = [];
  for (let i=1;i<lines.length;i++){
    const cells = lines[i].split(',').map(c => c.trim());
    if (cells.length < 4) continue;
    rows.push({
      date: cells[idxDate],
      start: cells[idxStart],
      end: cells[idxEnd],
      category: cells[idxCat] || 'Unknown'
    });
  }
  return rows;
}

function toDateTime(dateStr,timeStr){
  const dParts=dateStr.split(/[-\/]/);
  let [y,m,d]=dParts.length===3?dParts:[2025,1,1];
  const [h,mi]=(timeStr||'0:0').split(':').map(x=>parseInt(x,10));
  return new Date(`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T${String(h).padStart(2,'0')}:${String(mi||0).padStart(2,'0')}:00`);
}

function computeDistribution(rows){
  const grouped = {};
  for(const r of rows){
    if(!grouped[r.category]) grouped[r.category] = [];
    grouped[r.category].push(r);
  }

  const result = {};
  for(const [cat, arr] of Object.entries(grouped)){
    const bins = new Array(24).fill(0);
    let totalMinutes = 0;
    const dayTotals = {}; // <---- NEW

    for(const r of arr){
      let start = toDateTime(r.date,r.start);
      let end = toDateTime(r.date,r.end);
      if(end <= start) end = new Date(end.getTime() + 24*60*60*1000);

      let cur = new Date(start);
      while(cur < end){
        bins[cur.getHours()]++;
        totalMinutes++;
        const dateKey = cur.toISOString().split('T')[0];
        dayTotals[dateKey] = (dayTotals[dateKey] || 0) + 1;
        cur = new Date(cur.getTime() + 60000);
      }
    }

    result[cat] = { bins, totalMinutes, dayTotals };
  }
  return result;
}


function drawChart(cat,data,color){
  const mode=modeSelect.value;
  const bins=data.bins;
  const total=data.totalMinutes||1;
  const W=900,H=320,pad={top:20,right:20,bottom:36,left:44};
  const innerW=W-pad.left-pad.right,innerH=H-pad.top-pad.bottom;
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  svg.setAttribute('width','100%');
  const tooltip=document.createElement('div');
  tooltip.className='tooltip';
  document.body.appendChild(tooltip);

  const maxVal=Math.max(...bins);
  const yMax=mode==='minutes'?Math.max(10,maxVal):100;
  const yScale=v=>pad.top+innerH*(1-(mode==='minutes'?v:yVal(v))/yMax);
  function yVal(v){return (v/total)*100;}

  // grid
  for(let i=0;i<=5;i++){
    const val=i*(yMax/5);
    const y=pad.top+innerH*(1-val/yMax);
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',pad.left);line.setAttribute('x2',W-pad.right);
    line.setAttribute('y1',y);line.setAttribute('y2',y);
    line.setAttribute('stroke','#f4f4f6');
    svg.appendChild(line);
    const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x',8);t.setAttribute('y',y+4);
    t.setAttribute('font-size',11);t.setAttribute('fill','#666');
    t.textContent=mode==='minutes'?Math.round(val)+'m':Math.round(val)+'%';
    svg.appendChild(t);
  }

  const barW=innerW/24*0.78,gap=(innerW/24)-barW;
  for(let h=0;h<24;h++){
    const x=pad.left+(innerW/24)*h+gap/2;
    const v=bins[h];
    const val=mode==='minutes'?v:yVal(v);
    const y=pad.top+innerH*(1-val/yMax);
    const height=pad.top+innerH-y;
    const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x',x);rect.setAttribute('y',y);
    rect.setAttribute('width',barW);rect.setAttribute('height',Math.max(0.1,height));
    rect.setAttribute('rx',4);rect.setAttribute('ry',4);
    rect.setAttribute('fill',color);
    rect.addEventListener('mousemove',e=>{
      const pct=(v/total*100).toFixed(2);
      tooltip.style.opacity=1;
      tooltip.innerHTML=`<b>${String(h).padStart(2,'0')}:00–${String((h+1)%24).padStart(2,'0')}:00</b><br>${v} min (${pct}%)`;
      tooltip.style.left=e.pageX+'px';
      tooltip.style.top=e.pageY+'px';
    });
    rect.addEventListener('mouseleave',()=>tooltip.style.opacity=0);
    svg.appendChild(rect);

    const label=document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('x',x+barW/2);
    label.setAttribute('y',pad.top+innerH+16);
    label.setAttribute('font-size',10);
    label.setAttribute('fill','#444');
    label.setAttribute('text-anchor','middle');
    label.textContent=String(h).padStart(2,'0');
    svg.appendChild(label);
  }

  const sumText=document.createElementNS('http://www.w3.org/2000/svg','text');
  sumText.setAttribute('x',pad.left);
  sumText.setAttribute('y',H-6);
  sumText.setAttribute('font-size',11);
  sumText.setAttribute('fill','#666');
  sumText.textContent=`Total: ${total} minutes`;
  svg.appendChild(sumText);
  return svg;
}

function drawHeatmap(cat, data, color) {
  const dayTotals = data.dayTotals || {};
  if (Object.keys(dayTotals).length === 0) return document.createTextNode('');

  // Determine date range: last 52 weeks
  const allDates = Object.keys(dayTotals).map(d => new Date(d));
  const lastDate = new Date();
  const end = new Date(lastDate);
  end.setDate(end.getDate() - end.getDay() + 6); // align to Saturday (end of week)
  const start = new Date(end);
  start.setDate(start.getDate() - 7 * 52 + 1); // 52 weeks back

  const W = 52 * 14 + 50;
  const H = 7 * 14 + 40;
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  svg.style.background = '#fff';
  svg.style.border = '1px solid #eee';
  svg.style.borderRadius = '6px';
  svg.style.marginTop = '4px';
  svg.style.width = '100%';

  const tooltip = document.createElement('div');
  tooltip.className = 'tooltip';
  document.body.appendChild(tooltip);

  const max = Math.max(...Object.values(dayTotals));

	function colorScale(v) {
  if (v === 0) return '#eee';
  const t = v / max; // 0 → white, 1 → full color
  return blendColor('#ffffff', color, t);
}

function blendColor(c1, c2, t) {
  // linear interpolate between two hex colors (c1→c2)
  const f = parseInt(c1.slice(1), 16);
  const g = parseInt(c2.slice(1), 16);
  const r1 = f >> 16, g1 = (f >> 8) & 0xff, b1 = f & 0xff;
  const r2 = g >> 16, g2 = (g >> 8) & 0xff, b2 = g & 0xff;
  const r = Math.round(r1 + (r2 - r1) * t);
  const g_ = Math.round(g1 + (g2 - g1) * t);
  const b = Math.round(b1 + (b2 - b1) * t);
  return `rgb(${r},${g_},${b})`;
}


  function shadeColor(col, percent) {
    const f = parseInt(col.slice(1), 16);
    const t = percent < 0 ? 0 : 255;
    const p = Math.abs(percent) / 100;
    const R = f >> 16, G = f >> 8 & 0x00FF, B = f & 0x0000FF;
    return (
      '#' +
      (
        0x1000000 +
        (Math.round((t - R) * p) + R) * 0x10000 +
        (Math.round((t - G) * p) + G) * 0x100 +
        (Math.round((t - B) * p) + B)
      )
        .toString(16)
        .slice(1)
    );
  }

  // draw 7x52 grid
  const MS_PER_DAY = 24 * 60 * 60 * 1000;
  let current = new Date(start);
  for (let w = 0; w < 52; w++) {
    for (let d = 0; d < 7; d++) {
      const date = new Date(start);
      date.setDate(start.getDate() + w * 7 + d);
      const key = date.toISOString().split('T')[0];
      const v = dayTotals[key] || 0;
      const x = 30 + w * 14;
      const y = 14 + d * 14;

      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.setAttribute('x', x);
      rect.setAttribute('y', y);
      rect.setAttribute('width', 12);
      rect.setAttribute('height', 12);
      rect.setAttribute('rx', 2);
      rect.setAttribute('ry', 2);
      rect.setAttribute('fill', colorScale(v));
      rect.addEventListener('mousemove', e => {
        tooltip.style.opacity = 1;
        tooltip.innerHTML = `<b>${key}</b><br>${v} min`;
        tooltip.style.left = e.pageX + 'px';
        tooltip.style.top = e.pageY + 'px';
      });
      rect.addEventListener('mouseleave', () => (tooltip.style.opacity = 0));
      svg.appendChild(rect);
    }
  }

  // weekday labels
  ['M', 'W', 'F'].forEach((d, i) => {
    const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    t.setAttribute('x', 12);
    t.setAttribute('y', 25 + i * 28 / 1);
    t.setAttribute('font-size', 9);
    t.setAttribute('fill', '#666');
    t.textContent = d;
    svg.appendChild(t);
  });

  // year labels (start month and end month)
  const startMonth = start.toLocaleString('default', { month: 'short' });
  const endMonth = end.toLocaleString('default', { month: 'short' });
  const t1 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  t1.setAttribute('x', 30);
  t1.setAttribute('y', H - 8);
  t1.setAttribute('font-size', 10);
  t1.setAttribute('fill', '#666');
  t1.textContent = startMonth;
  svg.appendChild(t1);
  const t2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  t2.setAttribute('x', W - 40);
  t2.setAttribute('y', H - 8);
  t2.setAttribute('font-size', 10);
  t2.setAttribute('fill', '#666');
  t2.textContent = endMonth;
  svg.appendChild(t2);

  return svg;
}

function drawCalendar(cat, data, color) {
  const rows = allRows.filter(r => r.category === cat);
  if (!rows.length) return document.createTextNode('');

  const today = new Date();
  const startDate = new Date(today);
  startDate.setDate(today.getDate() - 29); // last 30 days
  const W = 900, H = 850, pad = { top: 20, right: 20, bottom: 30, left: 40 };
  const innerW = W - pad.left - pad.right;
  const innerH = H - pad.top - pad.bottom;
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  svg.style.background = '#fff';
  svg.style.border = '1px solid #eee';
  svg.style.borderRadius = '8px';
  svg.style.marginTop = '4px';
  svg.style.width = '100%';

  const tooltip = document.createElement('div');
  tooltip.className = 'tooltip';
  document.body.appendChild(tooltip);

  const dayWidth = innerW / 30;
  const hourHeight = innerH / 24;

  // vertical grid lines (days)
  for (let i=0; i<=30; i++){
    const x = pad.left + i*dayWidth;
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', x); line.setAttribute('x2', x);
    line.setAttribute('y1', pad.top); line.setAttribute('y2', pad.top+innerH);
    line.setAttribute('stroke','#f4f4f6');
    svg.appendChild(line);
    if(i<30){
      const date = new Date(startDate);
      date.setDate(startDate.getDate()+i);
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', x+dayWidth/2);
      t.setAttribute('y', H-6);
      t.setAttribute('font-size',9);
      t.setAttribute('fill','#666');
      t.setAttribute('text-anchor','middle');
      t.textContent = date.toISOString().slice(5,10); // MM-DD
      svg.appendChild(t);
    }
  }

  // horizontal grid lines (hours)
  for(let h=0; h<=24; h++){
    const y = pad.top + h*hourHeight;
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', pad.left); line.setAttribute('x2', pad.left+innerW);
    line.setAttribute('y1', y); line.setAttribute('y2', y);
    line.setAttribute('stroke','#f4f4f6');
    svg.appendChild(line);
    if(h<24){
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', 2);
      t.setAttribute('y', y+hourHeight/2+3);
      t.setAttribute('font-size',9);
      t.setAttribute('fill','#666');
      t.textContent = String(h).padStart(2,'0') + ':00';
      svg.appendChild(t);
    }
  }

  // draw activities
  rows.forEach(r=>{
    let start = toDateTime(r.date,r.start);
    let end = toDateTime(r.date,r.end);
    if(end <= start) end = new Date(end.getTime() + 24*60*60*1000);

    // skip if outside last 30 days
    if(end < startDate) return;
    if(start > today) return;

    const dayIndex = Math.floor((start - startDate)/(24*60*60*1000));
    const x = pad.left + dayIndex * dayWidth;
    const yStart = pad.top + start.getHours() * hourHeight + start.getMinutes()/60*hourHeight;
    const yEnd = pad.top + end.getHours() * hourHeight + end.getMinutes()/60*hourHeight;
    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', x+1);
    rect.setAttribute('y', yStart);
    rect.setAttribute('width', dayWidth-2);
    rect.setAttribute('height', Math.max(yEnd-yStart, 1));
    rect.setAttribute('rx',2); rect.setAttribute('ry',2);
    rect.setAttribute('fill', color);
    rect.addEventListener('mousemove', e=>{
      tooltip.style.opacity=1;
      tooltip.innerHTML=`<b>${r.date}</b><br>${r.start}–${r.end}`;
      tooltip.style.left = e.pageX+'px';
      tooltip.style.top = e.pageY+'px';
    });
    rect.addEventListener('mouseleave', ()=>tooltip.style.opacity=0);
    svg.appendChild(rect);
  });

  return svg;
}

function drawCombinedCalendar(rows) {
  if (!rows.length) return document.createTextNode('');

  const today = new Date();
  const startDate = new Date(today);
  startDate.setDate(today.getDate() - 29); // last 30 days
  const W = 900, H = 850, pad = { top: 20, right: 20, bottom: 30, left: 40 };
  const innerW = W - pad.left - pad.right;
  const innerH = H - pad.top - pad.bottom;
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  svg.style.background = '#fff';
  svg.style.border = '1px solid #eee';
  svg.style.borderRadius = '8px';
  svg.style.width = '100%';

  const tooltip = document.createElement('div');
  tooltip.className = 'tooltip';
  document.body.appendChild(tooltip);

  const dayWidth = innerW / 30;
  const hourHeight = innerH / 24;

  // Map categories to colors
  const categories = [...new Set(rows.map(r => r.category))];
  const catColor = {};
  categories.forEach((c,i)=> catColor[c] = palette[i%palette.length]);

  // vertical grid lines (days)
  for (let i=0; i<=30; i++){
    const x = pad.left + i*dayWidth;
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', x); line.setAttribute('x2', x);
    line.setAttribute('y1', pad.top); line.setAttribute('y2', pad.top+innerH);
    line.setAttribute('stroke','#f4f4f6');
    svg.appendChild(line);

    if(i<30){
      const date = new Date(startDate);
      date.setDate(startDate.getDate()+i);
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', x+dayWidth/2);
      t.setAttribute('y', H-6);
      t.setAttribute('font-size',9);
      t.setAttribute('fill','#666');
      t.setAttribute('text-anchor','middle');
      t.textContent = date.toISOString().slice(5,10); // MM-DD
      svg.appendChild(t);
    }
  }

  // horizontal grid lines (hours)
  for(let h=0; h<=24; h++){
    const y = pad.top + h*hourHeight;
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', pad.left); line.setAttribute('x2', pad.left+innerW);
    line.setAttribute('y1', y); line.setAttribute('y2', y);
    line.setAttribute('stroke','#f4f4f6');
    svg.appendChild(line);

    if(h<24){
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', 2);
      t.setAttribute('y', y+hourHeight/2+3);
      t.setAttribute('font-size',9);
      t.setAttribute('fill','#666');
      t.textContent = String(h).padStart(2,'0') + ':00';
      svg.appendChild(t);
    }
  }

  // draw activities
  rows.forEach(r=>{
    let start = toDateTime(r.date,r.start);
    let end = toDateTime(r.date,r.end);
    if(end <= start) end = new Date(end.getTime() + 24*60*60*1000);

    // skip if outside last 30 days
    if(end < startDate) return;
    if(start > today) return;

    const dayIndex = Math.floor((start - startDate)/(24*60*60*1000));
    const x = pad.left + dayIndex * dayWidth;
    const yStart = pad.top + start.getHours() * hourHeight + start.getMinutes()/60*hourHeight;
    const yEnd = pad.top + end.getHours() * hourHeight + end.getMinutes()/60*hourHeight;

    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', x+1);
    rect.setAttribute('y', yStart);
    rect.setAttribute('width', dayWidth-2);
    rect.setAttribute('height', Math.max(yEnd-yStart, 1));
    rect.setAttribute('rx',2); rect.setAttribute('ry',2);
    rect.setAttribute('fill', catColor[r.category]);
    rect.addEventListener('mousemove', e=>{
      tooltip.style.opacity=1;
      tooltip.innerHTML=`<b>${r.date}</b><br>${r.start}–${r.end} (${r.category})`;
      tooltip.style.left = e.pageX+'px';
      tooltip.style.top = e.pageY+'px';
    });
    rect.addEventListener('mouseleave', ()=>tooltip.style.opacity=0);
    svg.appendChild(rect);
  });

  return svg;
}

function drawAll(grouped){
  chartsContainer.innerHTML='';
  const cats=Object.keys(grouped);
  cats.forEach((cat,i)=>{
    const color=palette[i%palette.length];

    const title=document.createElement('div');
    title.className='category-title';
    title.innerHTML=`<span class="color-box" style="background:${color}"></span>${cat}`;
    chartsContainer.appendChild(title);

    const wrap=document.createElement('div');
    wrap.className='chart-wrap';
    wrap.appendChild(drawChart(cat,grouped[cat],color));
    chartsContainer.appendChild(wrap);

    const heatmapWrap = document.createElement('div');
    heatmapWrap.className='chart-wrap';
    heatmapWrap.appendChild(drawHeatmap(cat, grouped[cat], color));
    chartsContainer.appendChild(heatmapWrap);

    const calDetails = document.createElement('details');
    calDetails.style.marginTop = '12px';
    const summary = document.createElement('summary');
    summary.textContent = 'Show calendar';
    summary.style.cursor = 'pointer';
		summary.style.color= 'gray';
    summary.style.fontSize = '14px';
    calDetails.appendChild(summary);

    const calWrap = document.createElement('div');
    calWrap.className = 'chart-wrap';
    calWrap.appendChild(drawCalendar(cat, grouped[cat], color));
    calDetails.appendChild(calWrap);

    chartsContainer.appendChild(calDetails);
  });
	const combinedWrap = document.createElement('div');
	combinedWrap.className='chart-wrap';
	combinedWrap.appendChild(drawCombinedCalendar(allRows));
	chartsContainer.appendChild(combinedWrap);
}


function runCSV(text){
  allRows=parseCSV(text);
  lastGrouped=computeDistribution(allRows);
  drawAll(lastGrouped);
}

function applyDateFilter(){
  if(!allRows.length) return;
  const start=startInput.value?new Date(startInput.value):null;
  const end=endInput.value?new Date(endInput.value+'T23:59'):null;
  const filtered=allRows.filter(r=>{
    const d=new Date(r.date);
    return (!start||d>=start)&&(!end||d<=end);
  });
  lastGrouped=computeDistribution(filtered);
  drawAll(lastGrouped);
}

runCSV(exampleCSV);
</script>
</body>
</html>

