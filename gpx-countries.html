<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GPX Countries by Day</title>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
<style>
body { font-family: Arial; padding: 20px; }
h1 { margin-bottom: 10px; }
h2 { margin-top: 30px; margin-bottom: 10px; }
input { margin-bottom: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background-color: #f2f2f2; }
#summary { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; }
#homeCountrySection { margin-bottom: 20px; }
#homeCountrySection label { margin-right: 10px; font-weight: bold; }
#homeCountrySelect { padding: 5px; font-size: 14px; }
</style>
</head>
<body>

<h1>GPX Countries by Day</h1>
<div id="homeCountrySection" style="display: none;">
  <label for="homeCountrySelect">Home Country:</label>
  <select id="homeCountrySelect"></select>
</div>
<div id="summary">
  <strong>Summary (excluding home country):</strong>
  <table id="summaryTable" style="margin-top: 10px;">
    <thead>
      <tr>
        <th>Country</th>
        <th>Date</th>
        <th>Stay</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="3">No GPX loaded yet.</td></tr>
    </tbody>
  </table>
</div>
<input type="file" id="gpxFiles" multiple accept=".gpx"/>
<h2>Raw data per day</h2>
<table id="resultTable">
  <thead>
    <tr><th>Date / File</th><th>Countries Visited</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let countriesGeoJSON;
let countryTimeline = [];
let allCountries = new Set();

// Country to flag emoji mapping
const countryFlags = {
  'Afghanistan': 'ðŸ‡¦ðŸ‡«', 'Albania': 'ðŸ‡¦ðŸ‡±', 'Algeria': 'ðŸ‡©ðŸ‡¿', 'Andorra': 'ðŸ‡¦ðŸ‡©', 'Angola': 'ðŸ‡¦ðŸ‡´',
  'Argentina': 'ðŸ‡¦ðŸ‡·', 'Armenia': 'ðŸ‡¦ðŸ‡²', 'Australia': 'ðŸ‡¦ðŸ‡º', 'Austria': 'ðŸ‡¦ðŸ‡¹', 'Azerbaijan': 'ðŸ‡¦ðŸ‡¿',
  'Bahamas': 'ðŸ‡§ðŸ‡¸', 'Bahrain': 'ðŸ‡§ðŸ‡­', 'Bangladesh': 'ðŸ‡§ðŸ‡©', 'Barbados': 'ðŸ‡§ðŸ‡§', 'Belarus': 'ðŸ‡§ðŸ‡¾',
  'Belgium': 'ðŸ‡§ðŸ‡ª', 'Belize': 'ðŸ‡§ðŸ‡¿', 'Benin': 'ðŸ‡§ðŸ‡¯', 'Bhutan': 'ðŸ‡§ðŸ‡¹', 'Bolivia': 'ðŸ‡§ðŸ‡´',
  'Bosnia and Herzegovina': 'ðŸ‡§ðŸ‡¦', 'Botswana': 'ðŸ‡§ðŸ‡¼', 'Brazil': 'ðŸ‡§ðŸ‡·', 'Brunei': 'ðŸ‡§ðŸ‡³', 'Bulgaria': 'ðŸ‡§ðŸ‡¬',
  'Burkina Faso': 'ðŸ‡§ðŸ‡«', 'Burundi': 'ðŸ‡§ðŸ‡®', 'Cambodia': 'ðŸ‡°ðŸ‡­', 'Cameroon': 'ðŸ‡¨ðŸ‡²', 'Canada': 'ðŸ‡¨ðŸ‡¦',
  'Cape Verde': 'ðŸ‡¨ðŸ‡»', 'Central African Republic': 'ðŸ‡¨ðŸ‡«', 'Chad': 'ðŸ‡¹ðŸ‡©', 'Chile': 'ðŸ‡¨ðŸ‡±', 'China': 'ðŸ‡¨ðŸ‡³',
  'Colombia': 'ðŸ‡¨ðŸ‡´', 'Comoros': 'ðŸ‡°ðŸ‡²', 'Congo': 'ðŸ‡¨ðŸ‡¬', 'Costa Rica': 'ðŸ‡¨ðŸ‡·', 'Croatia': 'ðŸ‡­ðŸ‡·',
  'Cuba': 'ðŸ‡¨ðŸ‡º', 'Cyprus': 'ðŸ‡¨ðŸ‡¾', 'Czech Republic': 'ðŸ‡¨ðŸ‡¿', 'Czechia': 'ðŸ‡¨ðŸ‡¿', 
  'Democratic Republic of the Congo': 'ðŸ‡¨ðŸ‡©', 'Denmark': 'ðŸ‡©ðŸ‡°', 'Djibouti': 'ðŸ‡©ðŸ‡¯', 'Dominica': 'ðŸ‡©ðŸ‡²',
  'Dominican Republic': 'ðŸ‡©ðŸ‡´', 'East Timor': 'ðŸ‡¹ðŸ‡±', 'Ecuador': 'ðŸ‡ªðŸ‡¨', 'Egypt': 'ðŸ‡ªðŸ‡¬', 'El Salvador': 'ðŸ‡¸ðŸ‡»',
  'Equatorial Guinea': 'ðŸ‡¬ðŸ‡¶', 'Eritrea': 'ðŸ‡ªðŸ‡·', 'Estonia': 'ðŸ‡ªðŸ‡ª', 'Ethiopia': 'ðŸ‡ªðŸ‡¹', 'Fiji': 'ðŸ‡«ðŸ‡¯',
  'Finland': 'ðŸ‡«ðŸ‡®', 'France': 'ðŸ‡«ðŸ‡·', 'Gabon': 'ðŸ‡¬ðŸ‡¦', 'Gambia': 'ðŸ‡¬ðŸ‡²', 'Georgia': 'ðŸ‡¬ðŸ‡ª',
  'Germany': 'ðŸ‡©ðŸ‡ª', 'Ghana': 'ðŸ‡¬ðŸ‡­', 'Greece': 'ðŸ‡¬ðŸ‡·', 'Grenada': 'ðŸ‡¬ðŸ‡©', 'Guatemala': 'ðŸ‡¬ðŸ‡¹',
  'Guinea': 'ðŸ‡¬ðŸ‡³', 'Guinea-Bissau': 'ðŸ‡¬ðŸ‡¼', 'Guyana': 'ðŸ‡¬ðŸ‡¾', 'Haiti': 'ðŸ‡­ðŸ‡¹', 'Honduras': 'ðŸ‡­ðŸ‡³',
  'Hungary': 'ðŸ‡­ðŸ‡º', 'Iceland': 'ðŸ‡®ðŸ‡¸', 'India': 'ðŸ‡®ðŸ‡³', 'Indonesia': 'ðŸ‡®ðŸ‡©', 'Iran': 'ðŸ‡®ðŸ‡·',
  'Iraq': 'ðŸ‡®ðŸ‡¶', 'Ireland': 'ðŸ‡®ðŸ‡ª', 'Israel': 'ðŸ‡®ðŸ‡±', 'Italy': 'ðŸ‡®ðŸ‡¹', 'Ivory Coast': 'ðŸ‡¨ðŸ‡®',
  'Jamaica': 'ðŸ‡¯ðŸ‡²', 'Japan': 'ðŸ‡¯ðŸ‡µ', 'Jordan': 'ðŸ‡¯ðŸ‡´', 'Kazakhstan': 'ðŸ‡°ðŸ‡¿', 'Kenya': 'ðŸ‡°ðŸ‡ª',
  'Kiribati': 'ðŸ‡°ðŸ‡®', 'Kuwait': 'ðŸ‡°ðŸ‡¼', 'Kyrgyzstan': 'ðŸ‡°ðŸ‡¬', 'Laos': 'ðŸ‡±ðŸ‡¦', 'Latvia': 'ðŸ‡±ðŸ‡»',
  'Lebanon': 'ðŸ‡±ðŸ‡§', 'Lesotho': 'ðŸ‡±ðŸ‡¸', 'Liberia': 'ðŸ‡±ðŸ‡·', 'Libya': 'ðŸ‡±ðŸ‡¾', 'Liechtenstein': 'ðŸ‡±ðŸ‡®',
  'Lithuania': 'ðŸ‡±ðŸ‡¹', 'Luxembourg': 'ðŸ‡±ðŸ‡º', 'Macedonia': 'ðŸ‡²ðŸ‡°', 'Madagascar': 'ðŸ‡²ðŸ‡¬', 'Malawi': 'ðŸ‡²ðŸ‡¼',
  'Malaysia': 'ðŸ‡²ðŸ‡¾', 'Maldives': 'ðŸ‡²ðŸ‡»', 'Mali': 'ðŸ‡²ðŸ‡±', 'Malta': 'ðŸ‡²ðŸ‡¹', 'Marshall Islands': 'ðŸ‡²ðŸ‡­',
  'Mauritania': 'ðŸ‡²ðŸ‡·', 'Mauritius': 'ðŸ‡²ðŸ‡º', 'Mexico': 'ðŸ‡²ðŸ‡½', 'Micronesia': 'ðŸ‡«ðŸ‡²', 'Moldova': 'ðŸ‡²ðŸ‡©',
  'Monaco': 'ðŸ‡²ðŸ‡¨', 'Mongolia': 'ðŸ‡²ðŸ‡³', 'Montenegro': 'ðŸ‡²ðŸ‡ª', 'Morocco': 'ðŸ‡²ðŸ‡¦', 'Mozambique': 'ðŸ‡²ðŸ‡¿',
  'Myanmar': 'ðŸ‡²ðŸ‡²', 'Namibia': 'ðŸ‡³ðŸ‡¦', 'Nauru': 'ðŸ‡³ðŸ‡·', 'Nepal': 'ðŸ‡³ðŸ‡µ', 'Netherlands': 'ðŸ‡³ðŸ‡±',
  'New Zealand': 'ðŸ‡³ðŸ‡¿', 'Nicaragua': 'ðŸ‡³ðŸ‡®', 'Niger': 'ðŸ‡³ðŸ‡ª', 'Nigeria': 'ðŸ‡³ðŸ‡¬', 'North Korea': 'ðŸ‡°ðŸ‡µ',
  'Norway': 'ðŸ‡³ðŸ‡´', 'Oman': 'ðŸ‡´ðŸ‡²', 'Pakistan': 'ðŸ‡µðŸ‡°', 'Palau': 'ðŸ‡µðŸ‡¼', 'Palestine': 'ðŸ‡µðŸ‡¸',
  'Panama': 'ðŸ‡µðŸ‡¦', 'Papua New Guinea': 'ðŸ‡µðŸ‡¬', 'Paraguay': 'ðŸ‡µðŸ‡¾', 'Peru': 'ðŸ‡µðŸ‡ª', 'Philippines': 'ðŸ‡µðŸ‡­',
  'Poland': 'ðŸ‡µðŸ‡±', 'Portugal': 'ðŸ‡µðŸ‡¹', 'Qatar': 'ðŸ‡¶ðŸ‡¦', 'Romania': 'ðŸ‡·ðŸ‡´', 'Russia': 'ðŸ‡·ðŸ‡º',
  'Rwanda': 'ðŸ‡·ðŸ‡¼', 'Saint Kitts and Nevis': 'ðŸ‡°ðŸ‡³', 'Saint Lucia': 'ðŸ‡±ðŸ‡¨', 'Saint Vincent and the Grenadines': 'ðŸ‡»ðŸ‡¨',
  'Samoa': 'ðŸ‡¼ðŸ‡¸', 'San Marino': 'ðŸ‡¸ðŸ‡²', 'Sao Tome and Principe': 'ðŸ‡¸ðŸ‡¹', 'Saudi Arabia': 'ðŸ‡¸ðŸ‡¦',
  'Senegal': 'ðŸ‡¸ðŸ‡³', 'Serbia': 'ðŸ‡·ðŸ‡¸', 'Seychelles': 'ðŸ‡¸ðŸ‡¨', 'Sierra Leone': 'ðŸ‡¸ðŸ‡±', 'Singapore': 'ðŸ‡¸ðŸ‡¬',
  'Slovakia': 'ðŸ‡¸ðŸ‡°', 'Slovenia': 'ðŸ‡¸ðŸ‡®', 'Solomon Islands': 'ðŸ‡¸ðŸ‡§', 'Somalia': 'ðŸ‡¸ðŸ‡´', 'South Africa': 'ðŸ‡¿ðŸ‡¦',
  'South Korea': 'ðŸ‡°ðŸ‡·', 'South Sudan': 'ðŸ‡¸ðŸ‡¸', 'Spain': 'ðŸ‡ªðŸ‡¸', 'Sri Lanka': 'ðŸ‡±ðŸ‡°', 'Sudan': 'ðŸ‡¸ðŸ‡©',
  'Suriname': 'ðŸ‡¸ðŸ‡·', 'Swaziland': 'ðŸ‡¸ðŸ‡¿', 'Sweden': 'ðŸ‡¸ðŸ‡ª', 'Switzerland': 'ðŸ‡¨ðŸ‡­', 'Syria': 'ðŸ‡¸ðŸ‡¾',
  'Taiwan': 'ðŸ‡¹ðŸ‡¼', 'Tajikistan': 'ðŸ‡¹ðŸ‡¯', 'Tanzania': 'ðŸ‡¹ðŸ‡¿', 'Thailand': 'ðŸ‡¹ðŸ‡­', 'Togo': 'ðŸ‡¹ðŸ‡¬',
  'Tonga': 'ðŸ‡¹ðŸ‡´', 'Trinidad and Tobago': 'ðŸ‡¹ðŸ‡¹', 'Tunisia': 'ðŸ‡¹ðŸ‡³', 'Turkey': 'ðŸ‡¹ðŸ‡·', 'Turkmenistan': 'ðŸ‡¹ðŸ‡²',
  'Tuvalu': 'ðŸ‡¹ðŸ‡»', 'Uganda': 'ðŸ‡ºðŸ‡¬', 'Ukraine': 'ðŸ‡ºðŸ‡¦', 'United Arab Emirates': 'ðŸ‡¦ðŸ‡ª', 'United Kingdom': 'ðŸ‡¬ðŸ‡§',
  'United States of America': 'ðŸ‡ºðŸ‡¸', 'United States': 'ðŸ‡ºðŸ‡¸', 'Uruguay': 'ðŸ‡ºðŸ‡¾', 'Uzbekistan': 'ðŸ‡ºðŸ‡¿',
  'Vanuatu': 'ðŸ‡»ðŸ‡º', 'Vatican City': 'ðŸ‡»ðŸ‡¦', 'Venezuela': 'ðŸ‡»ðŸ‡ª', 'Vietnam': 'ðŸ‡»ðŸ‡³', 'Yemen': 'ðŸ‡¾ðŸ‡ª',
  'Zambia': 'ðŸ‡¿ðŸ‡²', 'Zimbabwe': 'ðŸ‡¿ðŸ‡¼'
};

function getFlagEmoji(countryName) {
  return countryFlags[countryName] || 'ðŸ´';
}

// Load world countries GeoJSON from GitHub
fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
  .then(res => res.json())
  .then(data => { 
    countriesGeoJSON = data; 
    const summaryTbody = document.querySelector('#summaryTable tbody');
    summaryTbody.innerHTML = '<tr><td colspan="3">No GPX loaded yet.</td></tr>';
  });

// Function to calculate days stayed in each country
function calculateDaysPerCountry(timeline) {
  const daysPerCountry = {};
  for (let entry of timeline) {
    const start = entry.start instanceof Date ? entry.start : new Date(entry.start);
    const end = entry.end instanceof Date ? entry.end : new Date(entry.end);
    // Calculate actual days difference
    const days = Math.max(1, (end - start) / (1000 * 60 * 60 * 24) + 1);
    daysPerCountry[entry.country] = (daysPerCountry[entry.country] || 0) + days;
  }
  return daysPerCountry;
}

// Function to detect home country (most days stayed)
function detectHomeCountry(timeline) {
  const daysPerCountry = calculateDaysPerCountry(timeline);
  let maxDays = 0;
  let homeCountry = null;
  for (let [country, days] of Object.entries(daysPerCountry)) {
    if (days > maxDays) {
      maxDays = days;
      homeCountry = country;
    }
  }
  return homeCountry;
}

// Function to update summary based on selected home country
function updateSummary() {
  const homeCountry = document.getElementById('homeCountrySelect').value;
  
  // Merge timeline: consecutive entries of same country are merged
  const mergedTimeline = [];
  for (let i = 0; i < countryTimeline.length; i++) {
    const entry = countryTimeline[i];
    if (mergedTimeline.length === 0) {
      mergedTimeline.push({ ...entry });
    } else {
      const last = mergedTimeline[mergedTimeline.length - 1];
      if (last.country === entry.country) {
        // Extend end date
        last.end = entry.end > last.end ? entry.end : last.end;
      } else {
        mergedTimeline.push({ ...entry });
      }
    }
  }

  // Build summary table, excluding home country
  const summaryTbody = document.querySelector('#summaryTable tbody');
  summaryTbody.innerHTML = '';
  
  const filteredTimeline = mergedTimeline.filter(entry => entry.country !== homeCountry);
  
  if (filteredTimeline.length === 0) {
    summaryTbody.innerHTML = '<tr><td colspan="3">No international travel detected.</td></tr>';
  } else {
    // Reverse to show most recent first
    filteredTimeline.reverse();
    for (let entry of filteredTimeline) {
      const startStr = entry.start.toISOString().split('T')[0];
      const endStr = entry.end.toISOString().split('T')[0];
      const days = Math.ceil((entry.end - entry.start) / (1000 * 60 * 60 * 24)) + 1;
      const flag = getFlagEmoji(entry.country);
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${flag} ${entry.country}</td>
        <td>${startStr} â†’ ${endStr}</td>
        <td>${days} day${days !== 1 ? 's' : ''}</td>
      `;
      summaryTbody.appendChild(row);
    }
  }
}

// Handle GPX file upload
document.getElementById('gpxFiles').addEventListener('change', async (event) => {
  const files = Array.from(event.target.files);
  if (!countriesGeoJSON) {
    alert("Country data not loaded yet. Try again in a few seconds.");
    return;
  }

  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';

  const filesWithDate = [];
  for (let file of files) {
    const text = await file.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(text, "application/xml");
    
    // Get all time elements from trackpoints
    const timeElements = xml.querySelectorAll('trkpt time');
    if (timeElements.length === 0) {
      console.warn(`No time data found in ${file.name}`);
      continue; // Skip files without time data
    }
    
    const firstTimeEl = timeElements[0];
    const lastTimeEl = timeElements[timeElements.length - 1];
    const startDate = new Date(firstTimeEl.textContent);
    const endDate = new Date(lastTimeEl.textContent);
    
    filesWithDate.push({ file, text, xml, startDate, endDate });
  }

  // Sort files chronologically (most recent first)
  filesWithDate.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

  countryTimeline = []; // reset
  allCountries = new Set(); // reset

  // Process each file
  for (let f of filesWithDate) {
    const file = f.file;
    const xml = f.xml;
    const trkpts = Array.from(xml.getElementsByTagName('trkpt'));
    const points = trkpts.map(pt => [parseFloat(pt.getAttribute('lon')), parseFloat(pt.getAttribute('lat'))]);

    const countriesVisited = new Set();

    for (let [lon, lat] of points) {
      const pt = turf.point([lon, lat]);
      for (let feature of countriesGeoJSON.features) {
        if (turf.booleanPointInPolygon(pt, feature)) {
          countriesVisited.add(feature.properties.name);
        }
      }
    }

    // Add row to table
    const dateDisplay = f.startDate.toISOString().split('T')[0];
    const row = document.createElement('tr');
    row.innerHTML = `<td>${dateDisplay} (${file.name})</td><td>${[...countriesVisited].join(', ')}</td>`;
    tbody.appendChild(row);

    // Add to timeline
    for (let c of countriesVisited) {
      countryTimeline.push({ country: c, start: f.startDate, end: f.endDate });
      allCountries.add(c);
    }
  }

  // Detect home country and populate dropdown
  const homeCountry = detectHomeCountry(countryTimeline);
  const select = document.getElementById('homeCountrySelect');
  select.innerHTML = '';
  
  const sortedCountries = Array.from(allCountries).sort();
  for (let country of sortedCountries) {
    const option = document.createElement('option');
    option.value = country;
    option.textContent = country;
    if (country === homeCountry) {
      option.selected = true;
    }
    select.appendChild(option);
  }
  
  // Show home country section
  document.getElementById('homeCountrySection').style.display = 'block';
  
  // Update summary
  updateSummary();
});

// Handle home country change
document.getElementById('homeCountrySelect').addEventListener('change', updateSummary);
</script>

</body>
</html>
